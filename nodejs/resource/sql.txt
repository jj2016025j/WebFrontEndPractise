
//sql
app.use(function (req, res, next) {
  var mysql = require("mysql");
  var conn = mysql.createConnection({
    host: "127.0.0.1",
    user: "root",
    password: "",
    database: "ticketdb"
  });

  conn.connect();
  req.mysql = conn;
  req.mysql.queryAsync = function (cmd, params) {
      return new Promise(function (resolve, reject) {
        req.mysql.query(cmd, params, function (err, data) {
          resolve(data);
        })
      });
  }

  next();
})


// 建立資料庫連線
var mysql = require('mysql');
var connection = mysql.createConnection({
	host : '127.0.0.1',
	user : 'root',
	password : '',
	database : 'labDB'
});

connection.connect(function(err) {
	// if (err) throw err;
	if (err) {
		console.log(JSON.stringify(err));
		return;
	}
});

// 依 HTTP 的 Method (POST/GET/PUT/DELETE) 進行增查修刪

app.get("/home/news", function (request, response) {

	connection.query('select * from news', 
		'',
		function(err, rows) {
			if (err)	{
				console.log(JSON.stringify(err));
				return;
			}
			
			response.send(JSON.stringify(rows));
		}
	);
    
})


app.post("/home/news", function (request, response) {

	connection.query(
		"insert into news set title = ?, ymd = ? ", 
			[
				request.body.title, 
				request.body.ymd
			]);
	response.send("row inserted.");
    
})


app.put("/home/news", function (request, response) {

	connection.query(
		"update news set title = ?, ymd = ? where newsId = " 
		    + request.body.newsId, 
			[
				request.body.title, 
				request.body.ymd
			]);
	response.send("row updated.");
    
})


app.delete("/home/news", function (request, response) {

	connection.query(
		"delete from news where newsId = " + request.body.newsId,
			[]
		);
	response.send("row deleted.");
    
})

